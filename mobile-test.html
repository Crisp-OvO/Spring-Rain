<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwenæ•°å­¦è§£é¢˜åŠ©æ‰‹ - æ‰‹æœºæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .status {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .content {
            padding: 30px 20px;
        }
        
        .test-section {
            margin-bottom: 30px;
        }
        
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
        }
        
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .result {
            background: #f8f9ff;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }
        
        .success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .error {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§® Qwenæ•°å­¦è§£é¢˜åŠ©æ‰‹</h1>
            <p>æ‰‹æœºç«¯APIæµ‹è¯•ç•Œé¢</p>
            <div class="status" id="connectionStatus">
                <span id="statusText">æ­£åœ¨æ£€æµ‹è¿æ¥...</span>
            </div>
        </div>
        
        <div class="content">
            <!-- è¿æ¥æµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ”— è¿æ¥æµ‹è¯•</h3>
                <button class="btn btn-primary" onclick="testConnection()">
                    æµ‹è¯•åç«¯è¿æ¥
                </button>
                <div id="connectionResult" class="result" style="display: none;"></div>
            </div>
            
            <!-- æ•°å­¦è§£é¢˜æµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ§® æ•°å­¦è§£é¢˜æµ‹è¯•</h3>
                <div class="input-group">
                    <label for="mathExpression">æ•°å­¦è¡¨è¾¾å¼ï¼š</label>
                    <input type="text" id="mathExpression" placeholder="ä¾‹å¦‚ï¼š2x + 3 = 7" value="2x + 3 = 7">
                </div>
                <button class="btn btn-success" onclick="solveMath()">
                    å¼€å§‹è§£é¢˜
                </button>
                <div id="solveResult" class="result" style="display: none;"></div>
            </div>
            
            <!-- OCRæµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ“· OCRè¯†åˆ«æµ‹è¯•</h3>
                <input type="file" id="imageFile" class="file-input" accept="image/*" onchange="uploadImage()">
                <label for="imageFile" class="file-label">
                    ğŸ“¸ é€‰æ‹©å›¾ç‰‡è¿›è¡ŒOCRè¯†åˆ«
                </label>
                <div id="ocrResult" class="result" style="display: none;"></div>
            </div>
            
            <!-- å†å²è®°å½•æµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ“š å†å²è®°å½•æµ‹è¯•</h3>
                <button class="btn btn-warning" onclick="getHistory()">
                    è·å–å†å²è®°å½•
                </button>
                <div id="historyResult" class="result" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://10.233.15.100:3001';
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.onload = function() {
            testConnection();
        };
        
        async function testConnection() {
            const statusText = document.getElementById('statusText');
            const result = document.getElementById('connectionResult');
            
            statusText.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
            statusText.className = 'loading';
            result.style.display = 'block';
            result.textContent = 'æ­£åœ¨è¿æ¥åˆ°åç«¯æœåŠ¡...\n';
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                statusText.textContent = 'âœ… è¿æ¥æˆåŠŸ';
                statusText.className = 'success';
                
                result.textContent = 'âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼\n\n' + 
                    'æœåŠ¡çŠ¶æ€: ' + data.status + '\n' +
                    'ç‰ˆæœ¬: ' + data.version + '\n' +
                    'æ•°å­¦æ¨¡å‹: ' + data.models.math + '\n' +
                    'OCRæ¨¡å‹: ' + data.models.ocr + '\n' +
                    'æ—¶é—´æˆ³: ' + data.timestamp;
                result.className = 'result success';
                
            } catch (error) {
                statusText.textContent = 'âŒ è¿æ¥å¤±è´¥';
                statusText.className = 'error';
                
                result.textContent = 'âŒ è¿æ¥æµ‹è¯•å¤±è´¥ï¼\n\n' +
                    'é”™è¯¯ä¿¡æ¯: ' + error.message + '\n\n' +
                    'è¯·æ£€æŸ¥ï¼š\n' +
                    '1. æ‰‹æœºå’Œç”µè„‘åœ¨åŒä¸€WiFiç½‘ç»œ\n' +
                    '2. åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ\n' +
                    '3. IPåœ°å€é…ç½®æ­£ç¡®';
                result.className = 'result error';
            }
        }
        
        async function solveMath() {
            const expression = document.getElementById('mathExpression').value;
            const result = document.getElementById('solveResult');
            
            if (!expression.trim()) {
                alert('è¯·è¾“å…¥æ•°å­¦è¡¨è¾¾å¼');
                return;
            }
            
            result.style.display = 'block';
            result.textContent = 'ğŸ§® æ­£åœ¨è§£é¢˜ä¸­...\næ­£åœ¨è°ƒç”¨Qwenæ•°å­¦æ¨¡å‹...';
            result.className = 'result loading';
            
            try {
                const response = await fetch(`${API_BASE}/math/solve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        expression: expression,
                        method: 'thinking'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResult = '';
                
                result.textContent = 'âœ… è§£é¢˜æˆåŠŸï¼\n\næ­£åœ¨æ¥æ”¶è§£é¢˜è¿‡ç¨‹...\n\n';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                result.textContent += '\n\nğŸ‰ è§£é¢˜å®Œæˆï¼';
                                result.className = 'result success';
                                return;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.type === 'content' && parsed.content) {
                                    fullResult += parsed.content;
                                    result.textContent = 'âœ… è§£é¢˜è¿‡ç¨‹ï¼š\n\n' + fullResult;
                                } else if (parsed.type === 'thinking' && parsed.content) {
                                    result.textContent += '\nğŸ’­ æ€è€ƒ: ' + parsed.content;
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯
                            }
                        }
                    }
                }
                
            } catch (error) {
                result.textContent = 'âŒ è§£é¢˜å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ' + error.message;
                result.className = 'result error';
            }
        }
        
        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const result = document.getElementById('ocrResult');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            result.style.display = 'block';
            result.textContent = 'ğŸ“· æ­£åœ¨è¿›è¡ŒOCRè¯†åˆ«...\næ­£åœ¨è°ƒç”¨Qwen-VLæ¨¡å‹...';
            result.className = 'result loading';
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const response = await fetch(`${API_BASE}/ocr/math`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    result.textContent = 'âœ… OCRè¯†åˆ«æˆåŠŸï¼\n\n' +
                        'è¯†åˆ«æ–‡æœ¬: ' + data.text + '\n' +
                        'æ•°å­¦è¡¨è¾¾å¼: ' + data.mathExpression + '\n' +
                        'ç½®ä¿¡åº¦: ' + (data.confidence * 100).toFixed(1) + '%\n' +
                        'æ¨¡å‹: ' + data.model + '\n' +
                        'æ—¶é—´æˆ³: ' + data.timestamp;
                    result.className = 'result success';
                    
                    // è‡ªåŠ¨å¡«å…¥è§£é¢˜è¾“å…¥æ¡†
                    if (data.mathExpression) {
                        document.getElementById('mathExpression').value = data.mathExpression;
                    }
                } else {
                    throw new Error(data.message || 'è¯†åˆ«å¤±è´¥');
                }
                
            } catch (error) {
                result.textContent = 'âŒ OCRè¯†åˆ«å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ' + error.message;
                result.className = 'result error';
            }
        }
        
        async function getHistory() {
            const result = document.getElementById('historyResult');
            
            result.style.display = 'block';
            result.textContent = 'ğŸ“š æ­£åœ¨è·å–å†å²è®°å½•...';
            result.className = 'result loading';
            
            try {
                const response = await fetch(`${API_BASE}/history?limit=5`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.problems && data.problems.length > 0) {
                    let historyText = 'âœ… å†å²è®°å½• (' + data.total + 'æ¡):\n\n';
                    
                    data.problems.forEach((problem, index) => {
                        historyText += `${index + 1}. ${problem.expression}\n`;
                        historyText += `   ç­”æ¡ˆ: ${problem.result}\n`;
                        historyText += `   æ—¶é—´: ${new Date(problem.timestamp).toLocaleString()}\n\n`;
                    });
                    
                    result.textContent = historyText;
                    result.className = 'result success';
                } else {
                    result.textContent = 'ğŸ“š æš‚æ— å†å²è®°å½•\n\næ‚¨å¯ä»¥å…ˆè¿›è¡Œä¸€äº›è§£é¢˜æ“ä½œï¼Œç„¶åå†æŸ¥çœ‹å†å²è®°å½•ã€‚';
                    result.className = 'result';
                }
                
            } catch (error) {
                result.textContent = 'âŒ è·å–å†å²è®°å½•å¤±è´¥ï¼\n\né”™è¯¯ä¿¡æ¯: ' + error.message;
                result.className = 'result error';
            }
        }
    </script>
</body>
</html> 